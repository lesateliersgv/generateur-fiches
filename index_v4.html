<!DOCTYPE html>
<html lang="fr" class="h-full">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Générateur de fiches – Guitare-Voix (fixed4)</title>

  <!-- Tailwind for styles -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Export libs -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <style>
    :root { --bg:#0a0a0a; --card:#111214; --muted:#9ca3af; --text:#f8fafc; --accent:#d4a252; --pill-bg:rgba(212,162,82,.18); --border:#1f2937; }
    .light { --bg:#f8fafc; --card:#ffffff; --muted:#475569; --text:#0f172a; --accent:#d4a252; --pill-bg:rgba(212,162,82,.18); --border:#e5e7eb; }
    body { background:var(--bg); color:var(--text); }
    .card { background:var(--card); border:1px solid var(--border); }
    .muted { color:var(--muted); }
    .accent { color:var(--accent); }
    .pill { background:var(--pill-bg); border:1px solid var(--accent); color:var(--accent); display:inline-flex; align-items:center; justify-content:center; text-align:center; }
    .btn { border:1px solid var(--border); background:var(--card); }
    .btn-gold { background:var(--accent); color:#111; font-weight:600; }
    .btn:hover { filter:brightness(1.05); }

    .lyrics-line { display:block; white-space:nowrap; }
    .word-wrap { display:inline-block; position:relative; padding-top:1.6rem; margin-right:.25rem; }
    .chord { position:absolute; top:0; left:0; right:0; text-align:center; font-weight:800; font-size:.9rem; line-height:1rem; color:var(--accent); }
    .lyrics-area { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }

    @media print {
      body{background:#fff!important;color:#000!important}
      #controls{display:none!important}
      #preview{box-shadow:none!important;background:#fff!important;color:#000!important}
      .chord{color:#000!important}
      .pill{background:#fff!important;color:#000!important;border-color:#000!important}
      .diagram-card{border-color:#000!important}
    }
  </style>
</head>
<body class="h-full">
  <div class="mx-auto max-w-7xl p-4">
    <!-- Header -->
    <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3 mb-4">
      <h1 class="text-xl font-bold tracking-tight"><span class="accent">★</span> Générateur de fiches – Guitare-Voix</h1>
      <div class="flex flex-wrap items-center gap-3 text-sm">
        <label class="inline-flex items-center gap-2"><input id="themeToggle" type="checkbox" checked> Thème sombre</label>
        <label class="inline-flex items-center gap-2"><input id="exportWhiteToggle" type="checkbox" checked> Export PDF fond blanc</label>
        <button id="printBtn" class="px-3 py-1.5 rounded-lg bg-sky-500 text-black font-semibold">Imprimer (Ctrl+P)</button>
      </div>
    </div>

    <!-- Controls -->
    <div id="controls" class="grid grid-cols-1 xl:grid-cols-4 gap-4 mb-6">
      <!-- Identité -->
      <div class="card rounded-2xl p-4 space-y-3">
        <h2 class="text-lg font-semibold">Identité</h2>
        <div class="flex items-center gap-3"><label class="w-28 text-sm muted">Logo</label><input id="logoInput" type="file" accept="image/*" class="block w-full text-sm" /></div>
        <div class="flex items-center gap-3"><label class="w-28 text-sm muted">Titre</label><input id="songTitle" class="w-full border rounded-lg px-3 py-2 text-sm bg-transparent" placeholder="Perfect" /></div>
        <div class="flex items-center gap-3"><label class="w-28 text-sm muted">Artiste</label><input id="songArtist" class="w-full border rounded-lg px-3 py-2 text-sm bg-transparent" placeholder="Ed Sheeran" /></div>
        <div class="flex items-center gap-3"><label class="w-28 text-sm muted">Tempo</label><input id="songTempo" class="w-24 border rounded-lg px-3 py-2 text-sm bg-transparent" placeholder="96" /><span class="muted text-sm">bpm</span></div>
        <div class="flex items-center gap-3"><label class="w-28 text-sm muted">Mesure</label><input id="songMeter" class="w-24 border rounded-lg px-3 py-2 text-sm bg-transparent" placeholder="4/4" /><span class="muted text-sm">ex. 4/4, 3/4, 6/8…</span></div>
        <div class="flex items-center gap-3"><label class="w-28 text-sm muted">Capo</label><input id="songCapo" class="w-24 border rounded-lg px-3 py-2 text-sm bg-transparent" placeholder="0" /><span class="muted text-sm">case</span></div>
      </div>

      <!-- Accords & Rythmique -->
      <div class="card rounded-2xl p-4 space-y-3">
        <h2 class="text-lg font-semibold">Accords & Rythmique</h2>
        <label class="text-sm">Accords (séparés par des virgules)
          <input id="chordsList" class="mt-1 w-full border rounded-lg px-3 py-2 text-sm bg-transparent" placeholder="G, Em, C, D" />
        </label>
        <label class="text-sm block">Rythmique (texte)
          <input id="rhythmText" class="mt-1 w-full border rounded-lg px-3 py-2 text-sm bg-transparent" placeholder="Feu de camp : Bas – Bas – Haut – Haut – Bas – Haut" />
        </label>
        <div class="flex items-center gap-3"><label class="w-40 text-sm muted">Fiche rythmique (image)</label><input id="rhythmImage" type="file" accept="image/*" class="block w-full text-sm" /></div>
      </div>

      <!-- Lyrics + actions -->
      <div class="card rounded-2xl p-4 space-y-3">
        <h2 class="text-lg font-semibold">Lyrics + Chords</h2>
        <p class="text-sm muted">Insère les accords <b>avant</b> le mot, entre crochets. Ex : <code class="px-1 rounded bg-black/20">[G]I found a [Em]love</code></p>
        <textarea id="lyricsInput" rows="10" class="lyrics-area w-full border rounded-lg px-3 py-2 text-sm bg-transparent" placeholder="[G]I found a [Em]love for me..."></textarea>
        <div class="flex flex-wrap gap-2">
          <button id="renderBtn" class="px-3 py-2 rounded-xl btn-gold text-sm">Rendre la fiche</button>
          <button id="exportBtn" class="px-3 py-2 rounded-xl bg-emerald-500 text-black text-sm font-semibold hover:brightness-95">Exporter en PDF</button>
        </div>
        <p class="text-xs muted">Raccourcis : <kbd class="px-1 border rounded">Ctrl</kbd> + <kbd class="px-1 border rounded">Enter</kbd> = rendre • <kbd class="px-1 border rounded">Ctrl</kbd> + <kbd class="px-1 border rounded">S</kbd> = PDF</p>
      </div>

      <!-- Sélection des diagrammes + ordre -->
      <div class="card rounded-2xl p-4 space-y-4 xl:col-span-4">
        <div class="space-y-3">
          <h2 class="text-lg font-semibold">Sélection des diagrammes</h2>
          <div class="flex flex-wrap gap-2 mb-2">
            <button id="selectAllBtn" class="btn px-2 py-1 rounded-lg text-sm">Tout sélectionner</button>
            <button id="selectNoneBtn" class="btn px-2 py-1 rounded-lg text-sm">Tout désélectionner</button>
          </div>
          <div id="diagramChooser" class="flex flex-wrap gap-2"></div>
        </div>

        <div class="space-y-2">
          <div class="flex flex-wrap items-center gap-2">
            <span class="text-sm font-semibold">Ordre des accords</span>
            <button id="orderFromLyricsBtn" class="btn px-2 py-1 rounded-lg text-sm">Depuis les paroles</button>
            <button id="orderAlphaBtn" class="btn px-2 py-1 rounded-lg text-sm">A → Z</button>
          </div>
          <ul id="orderList" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-2"></ul>
          <p class="text-xs muted">Glisse-dépose les pastilles pour réordonner. L’affichage des diagrammes suit cet ordre.</p>
        </div>
      </div>

      <!-- Consignes -->
      <div class="card rounded-2xl p-4 space-y-3 xl:col-span-4">
        <h2 class="text-lg font-semibold">Consignes (chant, guitare, etc.)</h2>
        <textarea id="instructionsInput" rows="4" class="w-full border rounded-lg px-3 py-2 text-sm bg-transparent" placeholder="Ex. Chant : respiration basse; Guitare : accent sur 2 et 4…"></textarea>
      </div>

      <!-- Songbox -->
      <div class="card rounded-2xl p-4 space-y-3 xl:col-span-4">
        <h2 class="text-lg font-semibold">Songbox (bibliothèque locale)</h2>
        <div class="flex flex-wrap gap-2">
          <button id="saveSongBtn" class="px-3 py-2 rounded-xl bg-emerald-500 text-black text-sm font-semibold">Enregistrer</button>
          <button id="exportLibBtn" class="btn px-3 py-2 rounded-xl text-sm">Exporter</button>
          <button id="importLibBtn" class="btn px-3 py-2 rounded-xl text-sm">Importer</button>
        </div>
        <ul id="libraryList" class="mt-2 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-2"></ul>
        <p class="text-xs muted">Stockage dans le navigateur. Pense à exporter si tu changes d’ordi.</p>
      </div>
    </div>

    <!-- Preview -->
    <div id="preview" class="card rounded-2xl shadow p-8 mx-auto max-w-[980px]">
      <div class="flex items-start gap-4">
        <img id="logoPreview" class="w-16 h-16 object-contain" alt="logo" />
        <div class="flex-1">
          <h1 id="titlePreview" class="text-2xl font-bold leading-tight">Titre de la chanson</h1>
          <p id="metaPreview" class="text-sm muted">Artiste • Tempo • Mesure</p>
        </div>
      </div>

      <div class="mt-5 grid grid-cols-1 md:grid-cols-2 gap-6">
        <div>
          <h3 class="text-lg font-semibold mb-2">Accords utilisés</h3>
          <div id="chordsPreview" class="flex flex-wrap gap-2"></div>
        </div>
        <div>
          <h3 class="text-lg font-semibold mb-2">Rythmique</h3>
          <p id="rhythmTextPreview" class="text-sm"></p>
          <img id="rhythmImgPreview" class="mt-2 max-h-40 object-contain" />
        </div>
      </div>

      <div class="mt-6">
        <h3 class="text-lg font-semibold mb-2">Diagrammes</h3>
        <div id="diagramsPreview" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-3"></div>
      </div>

      <div class="mt-6">
        <h3 class="text-lg font-semibold mb-2">Consignes</h3>
        <div id="instructionsPreview" class="text-sm whitespace-pre-wrap"></div>
      </div>

      <hr class="my-6" style="border-color: var(--border)" />

      <div>
        <h3 class="text-lg font-semibold mb-2">Paroles</h3>
        <div id="lyricsPreview" class="space-y-1 text-base leading-7"></div>
      </div>
    </div>
  </div>

  <script>
    // ===== Theme
    const htmlEl = document.documentElement;
    function setTheme(isDark){ htmlEl.classList.toggle('light', !isDark); }
    const themeToggle = document.getElementById('themeToggle');
    themeToggle.addEventListener('change', ()=> setTheme(themeToggle.checked));
    setTheme(true);

    // ===== Elements
    const logoInput = document.getElementById('logoInput');
    const logoPreview = document.getElementById('logoPreview');
    const songTitle = document.getElementById('songTitle');
    const songArtist = document.getElementById('songArtist');
    const songTempo = document.getElementById('songTempo');
    const songMeter = document.getElementById('songMeter');
    const songCapo = document.getElementById('songCapo');
    const chordsList = document.getElementById('chordsList');
    const rhythmText = document.getElementById('rhythmText');
    const rhythmImage = document.getElementById('rhythmImage');
    const lyricsInput = document.getElementById('lyricsInput');
    const instructionsInput = document.getElementById('instructionsInput');

    const titlePreview = document.getElementById('titlePreview');
    const metaPreview = document.getElementById('metaPreview');
    const chordsPreview = document.getElementById('chordsPreview');
    const rhythmTextPreview = document.getElementById('rhythmTextPreview');
    const rhythmImgPreview = document.getElementById('rhythmImgPreview');
    const lyricsPreview = document.getElementById('lyricsPreview');
    const instructionsPreview = document.getElementById('instructionsPreview');

    const diagramChooser = document.getElementById('diagramChooser');
    const selectAllBtn = document.getElementById('selectAllBtn');
    const selectNoneBtn = document.getElementById('selectNoneBtn');

    const renderBtn = document.getElementById('renderBtn');
    const exportBtn = document.getElementById('exportBtn');
    const printBtn = document.getElementById('printBtn');

    // ===== State
    const selectedChords = new Set();
    let diagramOrder = []; // ordre explicite

    // ===== Bank (SVG) — G updated 3–2–0–0–3–3
    const chordBank = {
      'C': { base:1, frets:['x','3','2','0','1','0'], fingers:[0,3,2,0,1,0] },
      'D': { base:1, frets:['x','x','0','2','3','2'], fingers:[0,0,0,1,3,2] },
      'E': { base:1, frets:['0','2','2','1','0','0'], fingers:[0,2,3,1,0,0] },
      'G': { base:1, frets:['3','2','0','0','3','3'], fingers:[3,2,0,0,3,4] },
      'A': { base:1, frets:['x','0','2','2','2','0'], fingers:[0,0,1,2,3,0] },
      'F': { base:1, frets:['1','3','3','2','1','1'], fingers:[1,3,4,2,1,1], barres:[{fret:1, from:6, to:1, finger:1}] },
      'Am':{ base:1, frets:['x','0','2','2','1','0'], fingers:[0,0,2,3,1,0] },
      'Em':{ base:1, frets:['0','2','2','0','0','0'], fingers:[0,2,3,0,0,0] },
      'Dm':{ base:1, frets:['x','x','0','2','3','1'], fingers:[0,0,0,2,3,1] },
      'Bm':{ base:2, frets:['x','2','4','4','3','2'], fingers:[0,1,3,4,2,1], barres:[{fret:2, from:5, to:1, finger:1}] },
      'F#':{ base:2, frets:['2','4','4','3','2','2'], fingers:[1,3,4,2,1,1], barres:[{fret:2, from:6, to:1, finger:1}] },
      'Gm':{ base:3, frets:['3','5','5','3','3','3'], fingers:[1,3,4,1,1,1], barres:[{fret:3, from:6, to:1, finger:1}] }
    };

    // ===== File -> DataURL
    function fileToDataURL(file){ return new Promise((resolve)=>{ if(!file){ resolve(''); return; } const r=new FileReader(); r.onload=e=>resolve(e.target.result); r.readAsDataURL(file); }); }
    logoInput.addEventListener('change', async ()=>{ logoPreview.src = await fileToDataURL(logoInput.files[0]); });
    rhythmImage.addEventListener('change', async ()=>{ rhythmImgPreview.src = await fileToDataURL(rhythmImage.files[0]); });

    // ===== Render parts
    function setMeta(){
      titlePreview.textContent = songTitle.value || 'Titre de la chanson';
      const meta=[];
      if(songArtist.value) meta.push(songArtist.value);
      if(songTempo.value) meta.push((songTempo.value + ' bpm').trim());
      if(songMeter.value) meta.push(songMeter.value.trim());
      if(songCapo && songCapo.value && String(songCapo.value).trim() !== '0'){ meta.push('Capo '+String(songCapo.value).trim()); }
      metaPreview.textContent = meta.join(' • ') || 'Artiste • Tempo • Mesure';
    }
    function setChords(){
      chordsPreview.innerHTML='';
      const list=(chordsList.value||'').split(',').map(s=>s.trim()).filter(Boolean);
      list.forEach(ch=>{
        const pill=document.createElement('span');
        pill.className='pill px-2 py-1 rounded-full text-sm font-semibold';
        pill.textContent=ch;
        chordsPreview.appendChild(pill);
      });
      renderChooser();
    }
    function setRhythm(){ rhythmTextPreview.textContent = rhythmText.value || ''; }

    function renderLyrics(text){
      lyricsPreview.innerHTML = '';
      const lines = text.split('\n');
      lines.forEach(line => {
        if(line.trim() === ''){ const br = document.createElement('div'); br.className='h-4'; lyricsPreview.appendChild(br); return; }
        const container = document.createElement('div'); container.className = 'lyrics-line';
        const tokens = []; let i=0;
        while(i < line.length){
          if(line[i] === '['){
            const j = line.indexOf(']', i);
            if(j !== -1){ tokens.push({type:'chord', value: line.slice(i+1, j).trim()}); i = j+1; continue; }
          }
          let j = i;
          while(j < line.length && line[j] !== '['){ j++; }
          tokens.push({type:'text', value: line.slice(i, j)});
          i = j;
        }
        let pendingChord = null;
        tokens.forEach(tok => {
          if(tok.type === 'chord'){ pendingChord = tok.value || ''; return; }
          if(tok.type === 'text'){
            const parts = tok.value.split(/(\s+)/);
            parts.forEach(part => {
              if(/\s+/.test(part)){ const space = document.createElement('span'); space.textContent = part; container.appendChild(space); }
              else if(part){
                const wrap = document.createElement('span'); wrap.className = 'word-wrap';
                if(pendingChord){ const chord = document.createElement('span'); chord.className = 'chord'; chord.textContent = pendingChord; wrap.appendChild(chord); pendingChord = null; }
                const word = document.createElement('span'); word.textContent = part; wrap.appendChild(word);
                container.appendChild(wrap);
              }
            });
          }
        });
        lyricsPreview.appendChild(container);
      });
    }

    // ===== Diagrams
    function renderChordSVG(def){
      const base = def.base || 1; const frets = def.frets; const fingers = def.fingers || [];
      const barres = def.barres || [];
      const w=160, h=200, left=26, top=24, fretCount=5, stringCount=6;
      const vGap = (h - top - 24) / fretCount; const hGap = (w - left - 16) / (stringCount-1);
      const svgNS='http://www.w3.org/2000/svg';
      const svg=document.createElementNS(svgNS,'svg'); svg.setAttribute('width', w); svg.setAttribute('height', h); svg.setAttribute('viewBox',`0 0 ${w} ${h}`);

      const frame=document.createElementNS(svgNS,'rect'); frame.setAttribute('x',left-8); frame.setAttribute('y',top-8); frame.setAttribute('width', (stringCount-1)*hGap+16); frame.setAttribute('height', fretCount*vGap+16); frame.setAttribute('fill','none'); frame.setAttribute('stroke','var(--border)'); svg.appendChild(frame);

      // (Nut removed intentionally)

      for(let s=0; s<stringCount; s++){
        const x = left + s*hGap; const line=document.createElementNS(svgNS,'line'); line.setAttribute('x1',x); line.setAttribute('x2',x); line.setAttribute('y1',top); line.setAttribute('y2', top + vGap*fretCount); line.setAttribute('stroke','var(--muted)'); svg.appendChild(line);
      }
      for(let f=0; f<=fretCount; f++){
        const y = top + f*vGap; const line=document.createElementNS(svgNS,'line'); line.setAttribute('x1',left); line.setAttribute('x2', left + hGap*(stringCount-1)); line.setAttribute('y1',y); line.setAttribute('y2',y); line.setAttribute('stroke','var(--muted)'); svg.appendChild(line);
      }

      for(let s=0; s<stringCount; s++){
        const val = frets[s]; const x = left + s*hGap; const y = top - 10;
        if(val==='x' || val==='X'){
          const text=document.createElementNS(svgNS,'text'); text.setAttribute('x',x); text.setAttribute('y',y); text.setAttribute('text-anchor','middle'); text.setAttribute('font-size','12'); text.setAttribute('fill','var(--muted)'); text.textContent='x'; svg.appendChild(text);
        } else if(val==='0' || val===0){
          const circle=document.createElementNS(svgNS,'circle'); circle.setAttribute('cx',x); circle.setAttribute('cy',y); circle.setAttribute('r',5); circle.setAttribute('fill','none'); circle.setAttribute('stroke','var(--accent)'); svg.appendChild(circle);
        }
      }

      for(let s=0; s<stringCount; s++){
        const val = frets[s]; const fret = (val==='x'||val==='X'||val==='0'||val===0)? null : Number(val);
        if(!fret) continue;
        const x = left + s*hGap; const y = top + (fret-0.5)*vGap;
        const dot=document.createElementNS(svgNS,'circle'); dot.setAttribute('cx',x); dot.setAttribute('cy',y); dot.setAttribute('r',7); dot.setAttribute('fill','var(--accent)'); svg.appendChild(dot);
        const finger = fingers[s]||''; if(finger){ const t=document.createElementNS(svgNS,'text'); t.setAttribute('x',x); t.setAttribute('y',y+3); t.setAttribute('text-anchor','middle'); t.setAttribute('font-size','9'); t.setAttribute('fill','#111'); t.textContent=String(finger); }
      }

      (barres||[]).forEach(b=>{
        const x1 = left + (stringCount - b.from)*hGap;
        const x2 = left + (stringCount - b.to)*hGap;
        const y = top + (b.fret-0.5)*vGap;
        const rect=document.createElementNS(svgNS,'rect'); rect.setAttribute('x', Math.min(x1,x2)-8); rect.setAttribute('y', y-8); rect.setAttribute('width', Math.abs(x2-x1)+16); rect.setAttribute('height', 16); rect.setAttribute('rx', 8); rect.setAttribute('fill','var(--accent)');
        svg.appendChild(rect);
        if(b.finger){ const t=document.createElementNS(svgNS,'text'); t.setAttribute('x',(x1+x2)/2); t.setAttribute('y',y+3); t.setAttribute('text-anchor','middle'); t.setAttribute('font-size','9'); t.setAttribute('fill','#111'); t.textContent=String(b.finger); }
      });

      return svg;
    }

    function effectiveSelection(){
      if(diagramOrder.length){
        return diagramOrder.filter(n=>selectedChords.has(n));
      }
      return Array.from(selectedChords);
    }

    function renderDiagramsPreview(){
      const diagramsPreview = document.getElementById('diagramsPreview');
      diagramsPreview.innerHTML='';
      const chosen = effectiveSelection();
      if(chosen.length===0){ return; }
      chosen.forEach(name=>{
        const wrap=document.createElement('div'); wrap.className='diagram-card border rounded-xl p-2 flex flex-col items-center gap-1';
        const title=document.createElement('div'); title.className='text-sm font-bold'; title.textContent=name || '—'; wrap.appendChild(title);
        if(chordBank[name]){ wrap.appendChild(renderChordSVG(chordBank[name])); }
        else { const ph=document.createElement('div'); ph.className='text-xs muted h-28 flex items-center justify-center text-center px-2'; ph.textContent='Pas de diagramme pour '+name; wrap.appendChild(ph); }
        diagramsPreview.appendChild(wrap);
      });
    }

    // ===== Chooser
    function allChordNames(){ return (chordsList.value||'').split(',').map(s=>s.trim()).filter(Boolean); }
    function ensureOrderConsistency(appendMissing=false){
      diagramOrder = diagramOrder.filter(n=>selectedChords.has(n));
      Array.from(selectedChords).forEach(n=>{ if(!diagramOrder.includes(n)){ if(appendMissing) diagramOrder.push(n); } });
    }
    function renderChooser(){
      diagramChooser.innerHTML='';
      const names = allChordNames();
      Array.from(selectedChords).forEach(n=>{ if(!names.includes(n)) selectedChords.delete(n); });
      names.forEach(name=>{
        const wrap=document.createElement('label');
        wrap.className='inline-flex items-center gap-1 border rounded-lg px-2 py-1 text-sm cursor-pointer';
        const cb=document.createElement('input'); cb.type='checkbox';
        cb.checked = selectedChords.size ? selectedChords.has(name) : false;
        cb.addEventListener('change', ()=>{
          if(cb.checked){ selectedChords.add(name); if(!diagramOrder.includes(name)) diagramOrder.push(name); }
          else { selectedChords.delete(name); diagramOrder = diagramOrder.filter(n=>n!==name); }
          renderOrderList();
          renderDiagramsPreview();
        });
        const span=document.createElement('span'); span.textContent=name;
        wrap.append(cb,span);
        diagramChooser.appendChild(wrap);
      });
      ensureOrderConsistency(true);
      renderOrderList();
    }
    selectAllBtn.addEventListener('click', ()=>{ allChordNames().forEach(n=>selectedChords.add(n)); ensureOrderConsistency(true); renderChooser(); renderDiagramsPreview(); });
    selectNoneBtn.addEventListener('click', ()=>{ selectedChords.clear(); diagramOrder=[]; renderChooser(); renderDiagramsPreview(); });

    // ===== Ordre (drag & drop + depuis paroles)
    const orderList = document.getElementById('orderList');
    const orderFromLyricsBtn = document.getElementById('orderFromLyricsBtn');
    const orderAlphaBtn = document.getElementById('orderAlphaBtn');

    function chordsFromLyrics(){
      const text = lyricsInput.value || '';
      const seq=[]; const seen=new Set();
      const regex = /\[([^\]]+)\]/g; let m;
      while((m = regex.exec(text)) !== null){
        const ch = m[1].trim();
        if(!seen.has(ch)){ seen.add(ch); seq.push(ch); }
      }
      return seq;
    }

    function renderOrderList(){
      orderList.innerHTML='';
      diagramOrder.forEach(name=>{
        if(!selectedChords.has(name)) return;
        const li=document.createElement('li');
        li.className='pill px-2 py-1 rounded-full text-sm font-semibold cursor-move flex items-center justify-between';
        li.draggable=true; li.dataset.name=name;
        li.innerHTML=`<span class="truncate">${name}</span><span class="muted text-[10px] ml-2">⋮⋮</span>`;
        li.addEventListener('dragstart', e=>{ e.dataTransfer.setData('text/plain', name); e.dataTransfer.effectAllowed='move'; });
        li.addEventListener('dragover', e=>{ e.preventDefault(); e.dataTransfer.dropEffect='move'; });
        li.addEventListener('drop', e=>{
          e.preventDefault();
          const dragged = e.dataTransfer.getData('text/plain');
          const target = name;
          if(!dragged || dragged===target) return;
          const from = diagramOrder.indexOf(dragged);
          const to = diagramOrder.indexOf(target);
          diagramOrder.splice(from,1);
          diagramOrder.splice(to,0,dragged);
          renderOrderList(); renderDiagramsPreview();
        });
        orderList.appendChild(li);
      });
    }

    orderFromLyricsBtn.addEventListener('click', ()=>{
      const seq = chordsFromLyrics();
      if(seq.length===0){ alert('Aucun accord détecté dans les paroles.'); return; }
      selectedChords.clear(); diagramOrder=[];
      seq.forEach(n=>{ selectedChords.add(n); diagramOrder.push(n); });
      renderChooser(); renderDiagramsPreview(); renderOrderList();
    });
    orderAlphaBtn.addEventListener('click', ()=>{
      diagramOrder.sort((a,b)=>a.localeCompare(b,'en'));
      renderOrderList(); renderDiagramsPreview();
    });

    // ===== Global render
    function renderAll(){
      setMeta();
      setChords();
      setRhythm();
      instructionsPreview.textContent = instructionsInput.value || '';
      renderLyrics(lyricsInput.value||'');
      renderDiagramsPreview();
    }

    // ===== Export
    async function doExport(){
      if(!window.html2canvas || !(window.jspdf && window.jspdf.jsPDF)){
        alert('Librairies PDF non chargées'); return;
      }
      renderAll();
      const node = document.getElementById('preview');
      const wasDark = themeToggle.checked;
      const forceWhite = document.getElementById('exportWhiteToggle').checked;
      if(forceWhite){ document.documentElement.classList.add('light'); }
      const canvas = await html2canvas(node, { scale: 2, useCORS: true, backgroundColor: '#ffffff' });
      const imgData = canvas.toDataURL('image/png'); const pdf = new window.jspdf.jsPDF({ unit:'pt', format:'a4' });
      const pageWidth = pdf.internal.pageSize.getWidth(); const pageHeight = pdf.internal.pageSize.getHeight(); const margin = 24;
      const ratio = Math.min((pageWidth - margin*2) / canvas.width, (pageHeight - margin*2) / canvas.height);
      const imgW = canvas.width * ratio; const imgH = canvas.height * ratio; const x = (pageWidth - imgW)/2; const y = margin;
      pdf.addImage(imgData, 'PNG', x, y, imgW, imgH);
      const title = (songTitle.value || 'Fiche_Guitare_Voix') + '.pdf'; pdf.save(title.replace(/\s+/g,'_'));
      if(forceWhite && wasDark){ document.documentElement.classList.remove('light'); }
    }

    // ===== Wire buttons
    renderBtn.addEventListener('click', renderAll);
    exportBtn.addEventListener('click', doExport);
    printBtn.addEventListener('click', ()=>window.print());
    lyricsInput.addEventListener('keydown', (e)=>{ if((e.ctrlKey||e.metaKey) && e.key==='Enter'){ e.preventDefault(); renderAll(); } });
    document.addEventListener('keydown', (e)=>{ if((e.ctrlKey||e.metaKey) && e.key.toLowerCase()==='s'){ e.preventDefault(); doExport(); }});

    // ===== Songbox (localStorage)
    const LIB_KEY='gv_songbox_v3';
    const saveSongBtn = document.getElementById('saveSongBtn');
    const exportLibBtn = document.getElementById('exportLibBtn');
    const importLibBtn = document.getElementById('importLibBtn');
    const libraryList = document.getElementById('libraryList');

    function readLib(){ try{ return JSON.parse(localStorage.getItem(LIB_KEY)||'{}'); } catch{ return {}; } }
    function writeLib(lib){ localStorage.setItem(LIB_KEY, JSON.stringify(lib)); }
    function slugify(s){ return (s||'').toLowerCase().trim().replace(/[^a-z0-9]+/g,'-').replace(/^-+|-+$/g,''); }
    function makeSongId(title, artist){
      const base = slugify(title||'sans-titre') + (artist? '-'+slugify(artist): '');
      return base || ('song-'+Date.now());
    }
    async function gather(){
      let logo = logoPreview && logoPreview.src ? logoPreview.src : '';
      let rhythmImg = rhythmImgPreview && rhythmImgPreview.src ? rhythmImgPreview.src : '';
      return {
        meta: { title: songTitle.value||'', artist: songArtist.value||'' },
        tempo: songTempo.value||'',
        meter: songMeter.value||'',
        capo: songCapo.value||'',
        chordsList: chordsList.value||'',
        rhythmText: rhythmText.value||'',
        rhythmImage: rhythmImg,
        lyrics: lyricsInput.value||'',
        instructions: instructionsInput.value||'',
        selectedChords: Array.from(selectedChords),
        diagramOrder: Array.from(diagramOrder),
        logo: logo,
        themeDark: themeToggle.checked,
        exportWhite: document.getElementById('exportWhiteToggle').checked
      };
    }
    function apply(data){
      const m = data.meta||{};
      songTitle.value=m.title||'';
      songArtist.value=m.artist||'';
      songTempo.value=data.tempo||'';
      songMeter.value=data.meter||'';
      songCapo.value=data.capo||'';
      chordsList.value=data.chordsList||'';
      rhythmText.value=data.rhythmText||'';
      lyricsInput.value=data.lyrics||'';
      instructionsInput.value=data.instructions||'';
      if(data.logo) logoPreview.src=data.logo;
      if(data.rhythmImage) rhythmImgPreview.src=data.rhythmImage;

      selectedChords.clear();
      (data.selectedChords||[]).forEach(n=>selectedChords.add(n));
      diagramOrder = Array.from(data.diagramOrder||[]);

      themeToggle.checked = !!data.themeDark;
      setTheme(!!data.themeDark);
      document.getElementById('exportWhiteToggle').checked = !!data.exportWhite;

      renderChooser(); renderAll();
    }
    function refreshLibraryList(){
      const lib = readLib();
      libraryList.innerHTML='';
      Object.entries(lib).sort((a,b)=> (a[1].meta.title||'').localeCompare(b[1].meta.title||'','fr')).forEach(([id,rec])=>{
        const li=document.createElement('li'); li.className='border rounded-xl p-2 flex items-center justify-between gap-2';
        const info=document.createElement('div'); info.className='min-w-0';
        const t=document.createElement('div'); t.className='font-semibold truncate'; t.textContent=rec.meta?.title||'Sans titre';
        const s=document.createElement('div'); s.className='text-xs muted truncate'; s.textContent=rec.meta?.artist||'—';
        info.append(t,s);
        const actions=document.createElement('div'); actions.className='flex gap-2';
        const load=document.createElement('button'); load.className='btn px-2 py-1 rounded-lg text-sm'; load.textContent='Charger'; load.addEventListener('click',()=>apply(rec));
        const del=document.createElement('button'); del.className='px-2 py-1 rounded-lg text-sm bg-red-500 text-white'; del.textContent='Supprimer'; del.addEventListener('click',()=>{ const lib=readLib(); delete lib[id]; writeLib(lib); refreshLibraryList(); });
        actions.append(load, del); li.append(info, actions); libraryList.appendChild(li);
      });
    }
    saveSongBtn.addEventListener('click', async ()=>{
      const data = await gather();
      let id = makeSongId(data.meta.title, data.meta.artist);
      const lib = readLib();
      if(lib[id]){
        let suffix=2; let newId;
        do{ newId = id + '-v' + suffix++; } while(lib[newId]);
        id=newId; data.meta.title = (data.meta.title||'') + ' (copie)';
      }
      lib[id]=data; writeLib(lib); refreshLibraryList(); alert('Enregistré dans la Songbox ✔');
    });
    exportLibBtn.addEventListener('click', ()=>{
      const data = JSON.stringify(readLib(), null, 2);
      const blob = new Blob([data], {type:'application/json'});
      const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'songbox.json'; a.click(); URL.revokeObjectURL(a.href);
    });
    importLibBtn.addEventListener('click', ()=>{
      const input=document.createElement('input'); input.type='file'; input.accept='application/json';
      input.onchange=async()=>{ const f=input.files?.[0]; if(!f) return; const text=await f.text(); try{ const obj=JSON.parse(text); const lib=readLib(); Object.assign(lib,obj); writeLib(lib); refreshLibraryList(); alert('Songbox importée ✔'); }catch(e){ alert('JSON invalide'); } };
      input.click();
    });

    // ===== Init
    (function init(){
      songTitle.value='Perfect'; songArtist.value='Ed Sheeran'; songTempo.value='96'; songMeter.value='12/8'; songCapo.value='';
      chordsList.value='G, Em, C, D';
      rhythmText.value='Bas – Haut – Bas – Haut – Bas…';
      lyricsInput.value='[G]I found a [Em]love for me\n[C]Darling just dive right in, and [D]follow my lead\n\n[G]Well I found a girl, [Em]beautiful and sweet\n[C]I never knew you were the [D]someone waiting for me';
      renderChooser();
      refreshLibraryList();
      renderAll();
    })();
  </script>
</body>
</html>
fix
